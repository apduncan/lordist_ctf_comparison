# Replication of LorDist & CTF benchmarks

This is a replication of benchmarks from 
[Qi et al. 2025](https://doi.org/10.1128/spectrum.01542-25), which compared
their method LorDist to a number of methods, including Compositional Tensor
Factorisation (CTF) 
([Martino et al., 2020](https://doi.org/10.1038/s41587-020-0660-7)).
We repeated these specific benchmarks as the CTF pseudo-F statistic showed
no change with increasing sparsity, where other methods showed monotonic
decrease. CTF also showed a uniform non-signficant P value across levels of
sparsity.

## Running these analyses
At the time of writing, the python package implementing CTF, gemelli, is
challenging to install due to conflicts with dependencies.
To alleviate this, and to make these analyses more reproducible, we have 
run all analyses using a Docker container.
The image is available from Github Container Repository as
`docker://ghcr.io/apduncan/lordist_ctf_comparison:submit`, and the Dockerfile
in this repository.
To run benchmarks (scripts `02_*` and `03_*`), we converted this to a
Singularity image to run on our HPC system.

## Initial test
Our initial step was to evaluate LorDist and CTF on the example data provided
in the LorDist repository, and add sparsity of different levels to it.
These early results showed that CTF returned significant PERMANOVA results on
these tests, so we proceeded implement a full replication of the Methods
described in Qi et al.
Generation of this benchmark dataset is covered in `01_load_simdata.Rmd`

## Benchmark replication
Following these early tests, we implemented the data simulation as described in
Qi et al. Methods, and generated 1000 initial matrices, each of which had
random sparsity from `0.1, 0.2, ... 0.7` applied.
These matrices, and their accompanying metadata, are generated by
`01a_simulate_data.Rmd`

One sample simulated matrix, and the metadata, are provided in this repository
to show the structure, in [`data/example`](data/example/).
All simulated matrices can be generated by rendering `01a_simulate_data.Rmd`.

Plots showing the value of the simulation functions are available in 
`results/simulated`.
The figure [`taxa_plots.png`](results/simulated/taxa_plots.png) shows the value
over time of simulated taxa for 50 subjects at 0 sparsity, with a fitted curve.
The figure [`function_check.png`](results/simulated/function_check.png) shows 
curves for the functions in case and control.

LorDist and CTF PERMANOVA results are produced by `02_lordist_benchmark.R`
and `03a_ctf_benchmark.py`.
These scripts have usage available with `--help`.

To gauge how challenging or simple a benchmark this simulation posed, we
added a method using established numerical ecology techniques.
We calculate the Bray-Curtis distance between samples, and take the distance
between pairs of subjects as the mean distance between samples from those
subjects.
This is implemented in `03b_bc_benchmark.R`.
Again usage is available with `--help`.

PERMANOVA results from the methods are combined and plotted in 
`04_plot_results.Rmd` [(rendered version)](04_plot_results.html).

## Additional exploration
### Validation of simulated taxa
To check no errors were being introduced while adding sparsity, we check
equivalence of non-zero entries in all matrices at different levels of sparsity,
find them to be equivalent in `06_check_high_sparsity.Rmd` 
[(rendered version)](06_check_high_sparsity.html).

To check how evident the abundance patterns of simulated taxa are at high
levels of sparsity, we produce plots for one example matrix at 70%
sparsity.
Those from our simulations look like the intended curves, albeit fragmented
[(figure)](results/simulated/check_sparse_taxa.png).

We also did the same for the example data provided in the LorDist repository.
The observed patterns of abundance do no match either our implementation,
or those described or depecited in Qi et al [(figure)](results/simulated/check_lordist_taxa.png).
No taxa display a sigmoid pattern over time; rather there are some taxa which
show a periodic rise and fall in the case group, while being static in control.
One simulated taxon is intended to have periodic rise and fall with
increasing amplitude over time, which is at least not visually evident in our
plots.
It is unclear from this how closely the initial benchmark data matched the
described methods, though the data in the repository may not be the
same as was used in simulation, but it is similar in structure (number of
individual, timepoints etc).

This is performed in `06_check_high_sparsity.Rmd` [(rendered version)](06_check_high_sparsity.html).

### Ordination at high sparsity
We performed PCoA on LorDist distances and mean Bray-Curtis dissimilarties,
to examine how intuitively clear the separation is between the simulated
phenotypes when at high levels of sparsity.
We used a single matrix at 70% sparsity.

These results are shown in `06_check_high_sparsity.Rmd`
[(rendered version)](06_check_high_sparsity.html).

Separation is clear on axis 1 of the Bray-Curtis results, while a less
clear separation is only evident on axes 5/6 of the LorDist based ordination 
[(figure)](results/simulated/pcoa_compare.png).